// Initialisation des notes
let notes = JSON.parse(localStorage.getItem("notes")) || [];

// R√©cup√©ration des √©l√©ments
const listeNotes = document.getElementById("listeNotes");
const moyenneElement = document.getElementById("moyenne");
const mentionElement = document.getElementById("mention");
const addBtn = document.getElementById("addBtn");
const resetBtn = document.getElementById("resetBtn");
const themeBtn = document.getElementById("themeBtn");
const baseNoteInput = document.getElementById("baseNote");
const noteInput = document.getElementById("noteInput");

const ctx = document.getElementById("graphique").getContext("2d");

// Cr√©ation du graphique Chart.js
let chart = new Chart(ctx, {
  type: "doughnut",
  data: {
    labels: [],
    datasets: [{
      data: [],
      backgroundColor: ["#3498db", "#9b59b6", "#2ecc71", "#f1c40f", "#e67e22"],
      hoverOffset: 30,
    }]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { position: "bottom" }
    }
  }
});

// Affiche les notes dans la liste
function afficherNotes() {
  listeNotes.innerHTML = "";
  notes.forEach((note, index) => {
    const li = document.createElement("li");
    li.innerHTML = `Note ${index + 1} : ${note.toFixed(2)}% <span onclick="supprimerNote(${index})" title="Supprimer cette note">üóëÔ∏è</span>`;
    listeNotes.appendChild(li);
  });
}

// Supprime une note par son index
function supprimerNote(index) {
  notes.splice(index, 1);
  sauvegarder();
  afficherNotes();
  calculerMoyenne();
  updateChart();
}

// Ajoute une note apr√®s conversion en %
function ajouterNote() {
  const noteRaw = parseFloat(noteInput.value);
  const base = parseFloat(baseNoteInput.value);

  if (isNaN(base) || base <= 0) {
    alert("La base de la note doit √™tre un nombre strictement positif.");
    return;
  }

  if (!isNaN(noteRaw) && noteRaw >= 0 && noteRaw <= base) {
    const note = (noteRaw / base) * 100;
    notes.push(note);
    noteInput.value = "";
    sauvegarder();
    afficherNotes();
    calculerMoyenne();
    updateChart();
  } else {
    alert(`Entrez une note valide entre 0 et ${base}.`);
  }
}

// R√©initialise toutes les notes
function reinitialiserNotes() {
  if (confirm("Voulez-vous vraiment tout r√©initialiser ?")) {
    notes = [];
    localStorage.removeItem("notes");
    afficherNotes();
    calculerMoyenne();
    updateChart();
  }
}

// Calcule et affiche la moyenne et la mention
function calculerMoyenne() {
  if (notes.length === 0) {
    moyenneElement.textContent = "Moyenne : 0%";
    mentionElement.textContent = "";
    return;
  }

  const somme = notes.reduce((acc, val) => acc + val, 0);
  const moyenne = (somme / notes.length).toFixed(2);
  moyenneElement.textContent = `Moyenne : ${moyenne}%`;

  let mention = "";
  if (moyenne >= 90) mention = "Excellent üíØ";
  else if (moyenne >= 75) mention = "Tr√®s bien ‚úÖ";
  else if (moyenne >= 60) mention = "Bien üëç";
  else if (moyenne >= 50) mention = "Passable üòê";
  else mention = "Insuffisant ‚ùå";

  mentionElement.textContent = mention;
}

// Sauvegarde les notes dans localStorage
function sauvegarder() {
  localStorage.setItem("notes", JSON.stringify(notes));
}

// Met √† jour le graphique
function updateChart() {
  chart.data.labels = notes.map((_, i) => `Note ${i + 1}`);
  chart.data.datasets[0].data = notes;
  chart.update();
}

// Bascule le th√®me sombre/clair
function toggleTheme() {
  document.body.classList.toggle("dark");
  if (document.body.classList.contains("dark")) {
    themeBtn.textContent = "Mode Clair";
    localStorage.setItem("theme", "dark");
  } else {
    themeBtn.textContent = "Mode Sombre";
    localStorage.setItem("theme", "light");
  }
}

// √âv√©nements
addBtn.addEventListener("click", ajouterNote);
resetBtn.addEventListener("click", reinitialiserNotes);
themeBtn.addEventListener("click", toggleTheme);

// Au chargement de la page
document.addEventListener("DOMContentLoaded", () => {
  afficherNotes();
  calculerMoyenne();
  updateChart();

  // Charger le th√®me sauvegard√©
  const savedTheme = localStorage.getItem("theme");
  if (savedTheme === "dark") {
    document.body.classList.add("dark");
    themeBtn.textContent = "Mode Clair";
  }
});
